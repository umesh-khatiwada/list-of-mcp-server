apiVersion: v1
kind: Namespace
metadata:
  name: cai-system
---
apiVersion: v1
kind: Secret
metadata:
  name: cai-secrets
  namespace: cai-system
type: Opaque
data:
  # Base64 encoded API keys (replace with your actual encoded keys)
  DEEPSEEK_API_KEY: c2stY2E4MTg0OTg3Y2IwNGNlOTlmNjhiYWI3MDBkYTA3MjE=
  OPENAI_API_KEY: ""
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cai-config
  namespace: cai-system
data:
  DEEPSEEK_API_URL: "https://api.deepseek.com/v1"
  CAI_STEAM: "true"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: cai-security-assessment
  namespace: cai-system
spec:
  template:
    metadata:
      labels:
        app: cai-job
    spec:
      restartPolicy: Never
      containers:
      - name: cai
        image: neptune1212/kali-cai:amd64
        imagePullPolicy: IfNotPresent
        command:
          - /bin/bash
          - -c
          - |
            set -e
            source /home/kali/cai/bin/activate
            echo "Starting CAI security assessment..."
            cp /config/agents.yml .

            # Set environment variables
            export TARGET="${TARGET:-target.com}"
            export OUTPUT_DIR="${OUTPUT_DIR:-/tmp}"
            export TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            cai --prompt "
            /agent redteam_agent
            Perform comprehensive security scan on $TARGET
            Test for common vulnerabilities
            /save $OUTPUT_DIR/scan_${TIMESTAMP}.json
            /cost
            /exit
            " 2>&1 | tee /tmp/cai-results.log

            echo "Scan completed. Results saved to $OUTPUT_DIR/scan_${TIMESTAMP}.json"
        env:
        - name: DEEPSEEK_API_KEY
          valueFrom:
            secretKeyRef:
              name: cai-secrets
              key: DEEPSEEK_API_KEY
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: cai-secrets
              key: OPENAI_API_KEY
        - name: DEEPSEEK_API_URL
          valueFrom:
            configMapKeyRef:
              name: cai-config
              key: DEEPSEEK_API_URL
        - name: CAI_MODEL
          value: "deepseek/deepseek-chat"
        - name: CAI_STEAM
          valueFrom:
            configMapKeyRef:
              name: cai-config
              key: CAI_STEAM
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        volumeMounts:
        - name: agents-config
          mountPath: /config
      volumes:
      - name: agents-config
        configMap:
          name: cai-agents-config
  backoffLimit: 3
  completions: 1
  parallelism: 1
